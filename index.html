<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GP Player Pro</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.3.0/dist/alphaTab.js"></script>

    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #222222;
            --btn-color: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --bar-bg: #f5f5f5;
        }

        body.dark-theme {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --bar-bg: #333333;
        }

        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100dvh;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, system-ui, sans-serif;
        }

        body { display: flex; flex-direction: column; }

        .toolbar {
            background-color: var(--bar-bg);
            padding: 10px;
            padding-top: calc(10px + var(--tg-safe-area-inset-top, 0px));
            display: flex;
            gap: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            z-index: 10;
            flex-wrap: wrap; /* –ß—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª–∏—Å—å –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
        }

        button, select {
            font-size: 13px;
            padding: 8px 10px;
            border-radius: 8px;
            border: none;
            background-color: var(--btn-color);
            color: var(--btn-text);
            font-weight: bold;
            cursor: pointer;
        }

        #trackList, #langSelector {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--btn-color);
        }

        #tab-view {
            flex: 1;
            overflow: auto;
            background-color: var(--bg-color);
            -webkit-overflow-scrolling: touch;
        }

        #fileInput { display: none; }

        #loading {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); color: white;
            display: none; align-items: center; justify-content: center;
            z-index: 1000; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div class="toolbar">
        <button id="openBtn">üìÅ –û—Ç–∫—Ä—ã—Ç—å</button>
        <button id="playBtn">‚ñ∂ –ò–≥—Ä–∞—Ç—å</button>
        <button id="themeBtn">üåì –¢–µ–º–∞</button>
        
        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ -->
        <select id="langSelector">
            <option value="ru">RU</option>
            <option value="en">EN</option>
        </select>

        <select id="trackList">
            <option data-lang="noFile">–ù–µ—Ç —Ñ–∞–π–ª–∞</option>
        </select>
    </div>

    <div id="tab-view">
        <div id="alphaTab"></div>
    </div>

    <input type="file" id="fileInput" accept=".gp,.gp3,.gp4,.gp5,.gpx">

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); 

        // –°–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–≤–æ–¥–æ–≤
        const translations = {
            ru: {
                open: "üìÅ –û—Ç–∫—Ä—ã—Ç—å",
                play: "‚ñ∂ –ò–≥—Ä–∞—Ç—å",
                pause: "‚è∏ –ü–∞—É–∑–∞",
                theme: "üåì –¢–µ–º–∞",
                loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
                noFile: "–ù–µ—Ç —Ñ–∞–π–ª–∞"
            },
            en: {
                open: "üìÅ Open",
                play: "‚ñ∂ Play",
                pause: "‚è∏ Pause",
                theme: "üåì Theme",
                loading: "Loading...",
                noFile: "No file"
            }
        };

        let currentLang = 'ru';

        function updateInterface() {
            const t = translations[currentLang];
            document.getElementById('openBtn').innerText = t.open;
            document.getElementById('themeBtn').innerText = t.theme;
            document.getElementById('loading').innerText = t.loading;
            
            // –ö–Ω–æ–ø–∫–∞ –ø–ª–µ–π/–ø–∞—É–∑–∞ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–ª–µ–µ—Ä–∞)
            if (api && api.playerState === 1) {
                document.getElementById('playBtn').innerText = t.pause;
            } else {
                document.getElementById('playBtn').innerText = t.play;
            }

            // –¢–µ–∫—Å—Ç "–ù–µ—Ç —Ñ–∞–π–ª–∞" –≤ —Å–ø–∏—Å–∫–µ –¥–æ—Ä–æ–∂–µ–∫
            const noFileOpt = document.querySelector('option[data-lang="noFile"]');
            if (noFileOpt) noFileOpt.innerText = t.noFile;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AlphaTab
        const el = document.querySelector('#alphaTab');
        const api = new alphaTab.AlphaTabApi(el, {
            player: {
                enablePlayer: true,
                soundFont: 'https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.3.0/dist/soundfonts/sonivox.sf2'
            }
        });

        // –°–æ–±—ã—Ç–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        document.getElementById('langSelector').onchange = (e) => {
            currentLang = e.target.value;
            updateInterface();
        };

        document.getElementById('openBtn').onclick = () => document.getElementById('fileInput').click();

        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('loading').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = (res) => {
                api.load(new Uint8Array(res.target.result));
            };
            reader.readAsArrayBuffer(file);
        };

        let isDark = false;
        document.getElementById('themeBtn').onclick = () => {
            isDark = !isDark;
            document.body.classList.toggle('dark-theme', isDark);
            api.settings.display.resources.mainColor = isDark ? '#ffffff' : '#000000';
            api.settings.display.staveRenderingConfig.staveColor = isDark ? '#ffffff' : '#000000';
            api.updateSettings();
            api.render();
        };

        api.scoreLoaded.on((score) => {
            document.getElementById('loading').style.display = 'none';
            const trackList = document.getElementById('trackList');
            trackList.innerHTML = '';
            score.tracks.forEach((track, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.innerText = track.name;
                trackList.appendChild(opt);
            });
            api.renderTracks([score.tracks[0]]);
        });

        document.getElementById('playBtn').onclick = () => api.playPause();

        api.playerStateChanged.on(() => {
            updateInterface(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–ª–µ–µ—Ä–∞
        });

        window.addEventListener('resize', () => api.render());

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        updateInterface();
    </script>
</body>
</html>


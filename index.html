<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GP Player</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.3.0/dist/alphaTab.js"></script>
    <style>
        :root { 
            --bg: #ffffff; 
            --txt: #222222; 
            --btn: var(--tg-theme-button-color, #2481cc); 
            --btn-txt: var(--tg-theme-button-text-color, #ffffff); 
            --bar: #f5f5f5;
            --overlay: rgba(0,0,0,0.5);
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –¢–ï–ú–ù–û–ô —Ç–µ–º—ã */
        body.dark { 
            --bg: #000000; 
            --txt: #ffffff; 
            --bar: #1a1a1a; 
            --overlay: rgba(0,0,0,0.8); 
        }
        
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100dvh; 
            overflow: hidden; background: var(--bg); color: var(--txt); 
            font-family: -apple-system, sans-serif; 
            transition: background 0.3s ease;
        }
        body { display: flex; flex-direction: column; }

        .header { 
            background: var(--bar); 
            padding: 10px; 
            padding-top: calc(10px + var(--tg-safe-area-inset-top, 0px)); 
            display: flex; align-items: center; gap: 10px; 
            border-bottom: 1px solid rgba(128,128,128,0.2); z-index: 10;
        }

        .hamburger {
            font-size: 24px; background: none; border: none; color: var(--txt); cursor: pointer; padding: 5px;
        }

        #trackList { 
            flex: 1; padding: 8px; border-radius: 8px; 
            background: var(--bar); color: var(--txt); 
            border: 1px solid var(--btn); font-size: 14px; 
        }

        .menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay); display: none; z-index: 100;
        }

        .side-menu {
            position: fixed; top: 0; left: -280px; width: 250px; height: 100%;
            background: var(--bg); z-index: 101; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; padding: 20px; 
            box-shadow: 5px 0 15px rgba(0,0,0,0.3);
        }

        .side-menu.active { left: 0; }
        .menu-overlay.active { display: block; }

        .menu-item {
            padding: 15px; margin-bottom: 12px; background: var(--btn); color: var(--btn-txt);
            border-radius: 10px; text-align: center; font-weight: bold; cursor: pointer; border: none;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #tab-view { 
            flex: 1; overflow: auto; background: var(--bg); 
            -webkit-overflow-scrolling: touch;
        }
        
        /* –ß—Ç–æ–±—ã –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –±—ã–ª–∏ –≤–∏–¥–Ω—ã –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
        #tab-view::-webkit-scrollbar { width: 5px; }
        #tab-view::-webkit-scrollbar-thumb { background: var(--btn); border-radius: 10px; }

        #loading { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: var(--bg); color: var(--txt); 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 1000; font-weight: bold; 
        }
    </style>
</head>
<body>
    <div id="loading">‚åõ <span id="txtLoad"></span></div>

    <div class="header">
        <button class="hamburger" id="menuBtn">&#9776;</button>
        <select id="trackList"><option value="0">...</option></select>
    </div>

    <div class="menu-overlay" id="overlay"></div>

    <div class="side-menu" id="sideMenu">
        <h3 style="text-align:center; margin-top:0;">Menu</h3>
        <button class="menu-item" id="openBtn">üìÅ <span id="txtOpen"></span></button>
        <button class="menu-item" id="playBtn">‚ñ∂ <span id="txtPlay"></span></button>
        <button id="themeBtn" class="menu-item">üåì <span id="txtTheme"></span></button>
    </div>

    <div id="tab-view">
        <div id="alphaTab"></div>
    </div>
    
    <input type="file" id="fileInput" accept=".gp,.gp3,.gp4,.gp5,.gpx" style="display:none">

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Unicode Dictionary to prevent "?" symbols
        const langMap = {
            ru: {
                open: "\u041E\u0442\u043A\u0440\u044B\u0442\u044C", // –û—Ç–∫—Ä—ã—Ç—å
                play: "\u0418\u0433\u0440\u0430\u0442\u044C", // –ò–≥—Ä–∞—Ç—å
                pause: "\u041F\u0430\u0443\u0437\u0430", // –ü–∞—É–∑–∞
                theme: "\u0422\u0435\u043C\u0430", // –¢–µ–º–∞
                load: "\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...", // –ó–∞–≥—Ä—É–∑–∫–∞
                empty: "\u041D\u0435\u0442 \u0444\u0430\u0439\u043B\u0430" // –ù–µ—Ç —Ñ–∞–π–ª–∞
            },
            en: {
                open: "Open", play: "Play", pause: "Pause", theme: "Theme", load: "Loading...", empty: "No file"
            }
        };

        const userLanguage = (tg.initDataUnsafe?.user?.language_code || navigator.language || 'en').toLowerCase();
        const L = (userLanguage.startsWith('ru') || userLanguage.startsWith('be') || userLanguage.startsWith('uk')) ? langMap.ru : langMap.en;

        const el = document.querySelector('#alphaTab');
        
        // Initializing AlphaTab with default settings
        const api = new alphaTab.AlphaTabApi(el, {
            player: { 
                enablePlayer: true, 
                soundFont: 'https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.3.0/dist/soundfonts/sonivox.sf2' 
            },
            display: {
                layoutMode: 'page',
                resources: {
                    mainColor: '#000000' // Default Black
                },
                staveRenderingConfig: {
                    staveColor: '#000000' // Default Black lines
                }
            }
        });

        const sideMenu = document.getElementById('sideMenu');
        const overlay = document.getElementById('overlay');
        const menuBtn = document.getElementById('menuBtn');
        let isDark = false;

        function toggleMenu() {
            sideMenu.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function updateUI() {
            document.getElementById('txtOpen').innerText = L.open;
            document.getElementById('txtTheme').innerText = L.theme;
            document.getElementById('txtLoad').innerText = L.load;
            document.getElementById('txtPlay').innerText = (api && api.playerState === 1) ? L.pause : L.play;
            if(!api.score) document.getElementById('trackList').options[0].innerText = L.empty;
        }

        menuBtn.onclick = toggleMenu;
        overlay.onclick = toggleMenu;

        document.getElementById('openBtn').onclick = () => { toggleMenu(); document.getElementById('fileInput').click(); };
        
        document.getElementById('fileInput').onchange = (e) => {
            const f = e.target.files[0]; if (!f) return;
            document.getElementById('loading').style.display = 'flex';
            const r = new FileReader(); r.onload = (res) => api.load(new Uint8Array(res.target.result));
            r.readAsArrayBuffer(f);
        };

        // --- THEME TOGGLE LOGIC ---
        document.getElementById('themeBtn').onclick = () => {
            toggleMenu();
            isDark = !isDark;
            document.body.classList.toggle('dark', isDark);

            // Change AlphaTab inner colors
            const color = isDark ? '#ffffff' : '#000000';
            api.settings.display.resources.mainColor = color;
            api.settings.display.staveRenderingConfig.staveColor = color;

            // Apply and re-render
            api.updateSettings();
            api.render();
        };

        document.getElementById('playBtn').onclick = () => { toggleMenu(); api.playPause(); };

        api.scoreLoaded.on((s) => {
            document.getElementById('loading').style.display = 'none';
            const tl = document.getElementById('trackList'); tl.innerHTML = '';
            s.tracks.forEach((t, i) => { const o = document.createElement('option'); o.value = i; o.innerText = t.name; tl.appendChild(o); });
            api.renderTracks([s.tracks[0]]);
        });

        api.playerStateChanged.on(() => updateUI());
        window.addEventListener('resize', () => api.render());

        updateUI();
    </script>
</body>
</html>



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GP Pro Player Fixed</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.7.1/dist/alphaTab.js"></script>
    <style>
        :root {
            --bg: #0b0b0b;
            --bar-bg: rgba(20, 20, 20, 0.98);
            --text: #ffffff;
            --accent: #2481cc;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100dvh;
            overflow: hidden; background: var(--bg); color: var(--text);
            font-family: -apple-system, sans-serif;
        }

        #loading {
            position: fixed; inset: 0; background: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; text-align: center; padding: 20px;
        }

        #progress-wrap {
            width: 80%; max-width: 300px; height: 8px; background: #222; 
            border-radius: 4px; margin: 20px 0; overflow: hidden; display: none;
        }
        #progress-fill { width: 0%; height: 100%; background: var(--accent); transition: width 0.2s; }

        .measure-bar {
            height: 4px; background: #222; display: flex; width: 100%;
        }
        .measure-progress { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        #tab-view { flex: 1; overflow: auto; background: #fff; }
        #alphaTab-fretboard { height: 100px; background: #1a1a1a; display: none; }

        @media (orientation: portrait) {
            body { display: flex; flex-direction: column; }
            .header { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: var(--bar-bg); }
            .footer { padding: 15px; background: var(--bar-bg); padding-bottom: calc(15px + var(--tg-safe-area-inset-bottom, 0px)); }
        }

        @media (orientation: landscape) {
            body { display: grid; grid-template-columns: 60px 1fr; grid-template-rows: 1fr 100px; }
            .header { grid-column: 1; grid-row: 1/3; flex-direction: column; display: flex; padding: 10px 0; background: var(--bar-bg); border-right: 1px solid #333; }
            #tab-view { grid-column: 2; grid-row: 1; }
            #alphaTab-fretboard { grid-column: 2; grid-row: 2; }
            .footer { display: none; }
        }

        .icon-btn { background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 10px; border-radius: 8px; cursor: pointer; }
        .play-btn { background: var(--accent); width: 60px; height: 60px; border-radius: 50%; font-size: 24px; }
    </style>
</head>
<body>

    <div id="loading">
        <div style="font-size: 40px; margin-bottom: 10px;">üé∏</div>
        <div id="status">Ready to Rock?</div>
        <div id="progress-wrap"><div id="progress-fill"></div></div>
        <button id="startBtn" onclick="initApp()" style="padding: 12px 30px; border-radius: 20px; border:none; background: var(--accent); color: white; font-weight: bold;">START PLAYER</button>
        <div id="error-log" style="font-size: 10px; color: #666; margin-top: 15px;"></div>
    </div>

    <div class="header">
        <button class="icon-btn" onclick="openFile()">üìÅ</button>
        <button class="icon-btn" onclick="toggleFretboard()">üé∏</button>
        <button class="icon-btn" onclick="toggleMetro()">‚è≥</button>
    </div>

    <div id="tab-view"><div id="alphaTab"></div></div>
    <div id="alphaTab-fretboard"></div>

    <div class="footer">
        <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
            <input type="range" id="tempoRange" min="0.25" max="2" step="0.1" value="1" style="width: 100px;">
            <button class="icon-btn play-btn" id="playBtn" onclick="handlePlay()">‚ñ∂</button>
            <div id="tempoDisplay">1.0x</div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".gp,.gp3,.gp4,.gp5,.gpx" style="display:none">

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let api = null;
        let isMetro = false;
        // –ó–∞–ø–∞—Å–Ω–æ–π URL –¥–ª—è –∑–≤—É–∫–æ–≤
        const sf2Url = 'https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.7.1/dist/soundfont/sonivox.sf2';

        async function initApp() {
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('progress-wrap').style.display = 'block';
            const status = document.getElementById('status');
            const fill = document.getElementById('progress-fill');

            status.innerText = "Loading Engine...";

            try {
                api = new alphaTab.AlphaTabApi(document.querySelector('#alphaTab'), {
                    player: {
                        enablePlayer: true,
                        soundFont: sf2Url,
                        enableCursor: true
                    },
                    display: { layoutMode: 'fluid', upscale: 2 }
                });

                // –í–∏–∑—É–∞–ª—å–Ω—ã–π –≥—Ä–∏—Ñ
                new alphaTab.gui.backings.Fretboard(document.querySelector('#alphaTab-fretboard'), api);

                api.soundFontLoadStatus.on((args) => {
                    const p = Math.floor((args.loaded / args.total) * 100);
                    fill.style.width = p + '%';
                    status.innerText = `Loading Sounds: ${p}%`;
                });

                api.soundFontLoaded.on(() => {
                    status.innerText = "Complete!";
                    setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
                });

                // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∑–≤—É–∫–æ–≤ –∑–∞–≤–∏—Å–Ω–µ—Ç –Ω–∞ 15 —Å–µ–∫—É–Ω–¥ - –ø—É—Å–∫–∞–µ–º —Ç–∞–∫
                setTimeout(() => {
                    if(document.getElementById('loading').style.display !== 'none') {
                        document.getElementById('loading').style.display = 'none';
                        console.warn("Soundfont timeout - starting without sound");
                    }
                }, 15000);

                setupEvents();

            } catch (err) {
                document.getElementById('error-log').innerText = err.message;
                status.innerText = "Offline Mode Enabled";
                setTimeout(() => document.getElementById('loading').style.display = 'none', 2000);
            }
        }

        function handlePlay() {
            if (api.player.host && api.player.host.audioContext) {
                api.player.host.audioContext.resume();
            }
            api.playPause();
        }

        function setupEvents() {
            api.playerStateChanged.on(() => {
                document.getElementById('playBtn').innerText = api.playerState === 1 ? "‚è∏" : "‚ñ∂";
            });

            document.getElementById('tempoRange').oninput = (e) => {
                const val = parseFloat(e.target.value);
                api.playbackSpeed = val;
                document.getElementById('tempoDisplay').innerText = val.toFixed(1) + 'x';
            };
        }

        function openFile() {
            const input = document.getElementById('fileInput');
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) api.load(file);
            };
            input.click();
        }

        function toggleFretboard() {
            const fb = document.getElementById('alphaTab-fretboard');
            fb.style.display = fb.style.display === 'block' ? 'none' : 'block';
            api.render();
        }

        function toggleMetro() {
            isMetro = !isMetro;
            api.settings.player.metronomeVolume = isMetro ? 1 : 0;
            api.updateSettings();
            tg.HapticFeedback.impactOccurred('light');
        }
    </script>
</body>
</html>


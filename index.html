<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TG Guitar Player</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.7.1/dist/alphaTab.js"></script>
    <style>
        :root { --bg: #ffffff; --txt: #222222; --btn: #2481cc; --btn-txt: #ffffff; --bar: #f8f8f8; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; background: var(--bg); color: var(--txt); font-family: -apple-system, sans-serif; }
        body { display: flex; flex-direction: column; }
        .header { background: var(--bar); padding: 10px; padding-top: calc(10px + var(--tg-safe-area-inset-top, 0px)); display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); z-index: 10; }
        #trackList { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--btn); font-size: 14px; background: #fff; }
        #tab-view { flex: 1; overflow: auto; background: #ffffff; -webkit-overflow-scrolling: touch; }
        .controls { background: var(--bar); padding: 15px 10px; padding-bottom: calc(15px + var(--tg-safe-area-inset-bottom, 0px)); display: flex; justify-content: center; align-items: center; gap: 20px; border-top: 1px solid rgba(0,0,0,0.1); z-index: 10; }
        .btn-main { background: var(--btn); color: var(--btn-txt); border: none; border-radius: 12px; padding: 10px; min-width: 80px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: opacity 0.2s; }
        .btn-main:active { opacity: 0.7; }
        .btn-main span:last-child { font-size: 10px; text-transform: uppercase; }
        
        #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; padding: 20px; }
        #progress-bar { width: 200px; height: 10px; background: #eee; border-radius: 5px; margin-top: 15px; overflow: hidden; display: none; }
        #progress-fill { width: 0%; height: 100%; background: var(--btn); transition: width 0.2s; }
        .metronome-active { background: #e74c3c !important; }
    </style>
</head>
<body>

    <div id="loading">
        <div style="font-size: 40px; margin-bottom: 10px;">üé∏</div>
        <div id="status">Loading HQ Sound Engine...</div>
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div id="percent" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
        <button id="skipLoading" style="display:none; margin-top: 20px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; background: #eee;">Enter without sound</button>
    </div>

    <div class="header">
        <button onclick="document.getElementById('fileInput').click()" style="background:none; border:none; font-size: 24px;">üìÅ</button>
        <select id="trackList"><option>No file loaded</option></select>
    </div>

    <div id="tab-view"><div id="alphaTab"></div></div>

    <div class="controls">
        <button class="btn-main" id="playBtn">
            <span id="icoPlay" style="font-size: 24px;">‚ñ∂</span><span id="txtPlay">Play</span>
        </button>
        <button class="btn-main" id="metroBtn">
            <span style="font-size: 24px;">‚è≤</span><span>Metro</span>
        </button>
    </div>
    
    <input type="file" id="fileInput" accept=".gp,.gp3,.gp4,.gp5,.gpx" style="display:none">

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const el = document.querySelector('#alphaTab');
        const status = document.getElementById('status');
        const loader = document.getElementById('loading');
        const pBar = document.getElementById('progress-bar');
        const pFill = document.getElementById('progress-fill');
        const pPercent = document.getElementById('percent');
        const skipBtn = document.getElementById('skipLoading');
        
        let lastBar = -1;

        // Give HQ sound 60 seconds to load before showing skip button
        setTimeout(() => { if(loader.style.display !== 'none') skipBtn.style.display = 'block'; }, 60000);
        skipBtn.onclick = () => loader.style.display = 'none';

        const api = new alphaTab.AlphaTabApi(el, {
            importer: { encoding: 'cp1251' },
            player: { 
                enablePlayer: true, 
                enableMetronome: true, 
                enableCursor: true,
                soundFont: 'https://realist59.github.io/TG_GuitarPro/sound.sf2' 
            }
        });

        api.soundFontLoad.on((e) => {
            pBar.style.display = 'block';
            const p = Math.floor(e.loaded / e.total * 100);
            pFill.style.width = p + '%';
            pPercent.innerText = p + '%';
            status.innerText = "Downloading High-Quality Sounds...";
        });

        api.soundFontLoaded.on(() => {
            status.innerText = "Sound Engine Ready!";
            setTimeout(() => loader.style.display = 'none', 800);
        });

        api.soundFontLoadFailed.on(() => {
            status.innerText = "HQ Sound failed. Using lite backup...";
            api.settings.player.soundFont = 'https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.7.1/dist/soundfont/sonivox.sf2';
            api.updateSettings();
        });

        document.getElementById('fileInput').onchange = (e) => {
            const f = e.target.files[0]; if(!f) return;
            loader.style.display = 'flex';
            status.innerText = "Loading File...";
            const r = new FileReader();
            r.onload = (res) => api.load(new Uint8Array(res.target.result));
            r.readAsArrayBuffer(f);
        };

        api.scoreLoaded.on((score) => {
            loader.style.display = 'none';
            const tl = document.getElementById('trackList');
            tl.innerHTML = '';
            score.tracks.forEach((t, i) => {
                const o = document.createElement('option');
                o.value = i; o.innerText = t.name || `Track ${i+1}`;
                tl.appendChild(o);
            });
            api.renderTracks([score.tracks[0]]);
        });

        api.playerPositionChanged.on((args) => {
            const currentBar = args.index + 1;
            if(currentBar !== lastBar) {
                lastBar = currentBar;
                if ('speechSynthesis' in window) {
                    const msg = new SpeechSynthesisUtterance("Bar " + currentBar);
                    msg.lang = 'en-US';
                    window.speechSynthesis.speak(msg);
                }
            }
        });

        document.getElementById('playBtn').onclick = () => api.playPause();
        document.getElementById('trackList').onchange = (e) => api.renderTracks([api.score.tracks[parseInt(e.target.value)]]);

        api.playerStateChanged.on(() => {
            const isPlaying = api.playerState === 1;
            document.getElementById('icoPlay').innerText = isPlaying ? "‚è∏" : "‚ñ∂";
            document.getElementById('txtPlay').innerText = isPlaying ? "Pause" : "Play";
        });

        window.addEventListener('resize', () => api.render());
    </script>
</body>
</html>







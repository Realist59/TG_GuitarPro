<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GP Player</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.3.0/dist/alphaTab.js"></script>
    <style>
        :root { 
            --bg: #ffffff; 
            --txt: #222222; 
            --btn: #2481cc; 
            --btn-txt: #ffffff; 
            --bar: #ffffff;
        }
        
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100dvh; 
            overflow: hidden; background: var(--bg); color: var(--txt); 
            font-family: -apple-system, sans-serif; 
        }
        body { display: flex; flex-direction: column; }

        /* Tabs Container */
        #tab-view { 
            flex: 1; 
            overflow: auto; 
            background: #ffffff; 
            -webkit-overflow-scrolling: touch; 
            padding-top: var(--tg-safe-area-inset-top, 0px);
        }

        /* Bottom Control Panel */
        .controls {
            background: var(--bar);
            padding: 15px 10px;
            padding-bottom: calc(15px + var(--tg-safe-area-inset-bottom, 0px));
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .btn-main {
            background: var(--btn);
            color: var(--btn-txt);
            border: none;
            border-radius: 12px;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 80px;
            transition: opacity 0.2s;
        }
        .btn-main:active { opacity: 0.7; }
        .btn-main span { font-size: 10px; text-transform: uppercase; }

        #loading { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(255,255,255,0.9); color: #000; 
            display: none; flex-direction: column; align-items: center; 
            justify-content: center; z-index: 1000; font-weight: bold; 
        }

        .metronome-active { background: #e74c3c !important; }
    </style>
</head>
<body>
    <div id="loading">‚åõ <span id="txtLoad">Loading...</span></div>

    <div id="tab-view">
        <div id="alphaTab"></div>
    </div>

    <div class="controls">
        <button class="btn-main" id="openBtn">
            <span style="font-size: 20px;">üìÅ</span>
            <span id="txtOpen">Open</span>
        </button>
        <button class="btn-main" id="playBtn" style="padding: 12px 25px;">
            <span id="icoPlay" style="font-size: 24px;">‚ñ∂</span>
            <span id="txtPlay">Play</span>
        </button>
        <button class="btn-main" id="metroBtn">
            <span style="font-size: 20px;">‚è≤</span>
            <span id="txtMetro">Metronome</span>
        </button>
    </div>
    
    <input type="file" id="fileInput" accept=".gp,.gp3,.gp4,.gp5,.gpx" style="display:none">

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // UI Labels
        const L = {
            open: "Open",
            play: "Play",
            pause: "Pause",
            metro: "Metronome",
            load: "Loading..."
        };

        const el = document.querySelector('#alphaTab');
        let metronomeEnabled = false;

        const api = new alphaTab.AlphaTabApi(el, {
            importer: { encoding: 'cp1251' }, // Keep cp1251 for file compatibility (Cyrillic tracks)
            player: { 
                enablePlayer: true, 
                enableMetronome: true, 
                metronomeVolume: 0,
                soundFont: 'https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.3.0/dist/soundfonts/sonivox.sf2' 
            },
            display: {
                layoutMode: 'page',
                resources: {
                    mainColor: '#000000', textColor: '#000000', titleColor: '#000000', subTitleColor: '#000000', wordsColor: '#000000'
                }
            }
        });

        function updateUI() {
            document.getElementById('txtOpen').innerText = L.open;
            document.getElementById('txtLoad').innerText = L.load;
            document.getElementById('txtMetro').innerText = L.metro;
            
            const isPlaying = api.playerState === 1;
            document.getElementById('txtPlay').innerText = isPlaying ? L.pause : L.play;
            document.getElementById('icoPlay').innerText = isPlaying ? '‚è∏' : '‚ñ∂';
        }

        // Open File logic
        document.getElementById('openBtn').onclick = () => document.getElementById('fileInput').click();
        
        document.getElementById('fileInput').onchange = (e) => {
            const f = e.target.files[0]; if (!f) return;
            document.getElementById('loading').style.display = 'flex';
            const r = new FileReader(); 
            r.onload = (res) => api.load(new Uint8Array(res.target.result));
            r.readAsArrayBuffer(f);
        };

        // Playback logic
        document.getElementById('playBtn').onclick = () => api.playPause();

        // Metronome logic
        document.getElementById('metroBtn').onclick = function() {
            metronomeEnabled = !metronomeEnabled;
            api.settings.player.metronomeVolume = metronomeEnabled ? 1 : 0;
            api.updateSettings();
            this.classList.toggle('metronome-active', metronomeEnabled);
        };

        api.scoreLoaded.on((s) => {
            document.getElementById('loading').style.display = 'none';
            api.renderTracks([s.tracks[0]]);
        });

        api.playerStateChanged.on(() => updateUI());
        
        window.addEventListener('resize', () => api.render());
        updateUI();
    </script>
</body>
</html>

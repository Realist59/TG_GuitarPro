<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GP Player Pro</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.3.0/dist/alphaTab.js"></script>

    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #222222;
            --btn-color: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --bar-bg: #f5f5f5;
        }
        body.dark-theme {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --bar-bg: #333333;
        }
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100dvh;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, system-ui, sans-serif;
        }
        body { display: flex; flex-direction: column; }
        .toolbar {
            background-color: var(--bar-bg);
            padding: 10px;
            padding-top: calc(10px + var(--tg-safe-area-inset-top, 0px));
            display: flex; gap: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            z-index: 10; flex-wrap: wrap;
        }
        button, select {
            font-size: 13px; padding: 8px 10px; border-radius: 8px;
            border: none; background-color: var(--btn-color);
            color: var(--btn-text); font-weight: bold; cursor: pointer;
        }
        #trackList, #langSelector {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--btn-color);
        }
        #tab-view { flex: 1; overflow: auto; background-color: var(--bg-color); }
        #fileInput { display: none; }
        #loading {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); color: white;
            display: none; align-items: center; justify-content: center;
            z-index: 1000; font-weight: bold;
        }
    </style>
</head>
<body>

    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–¥—ã –≤–º–µ—Å—Ç–æ –±—É–∫–≤ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ -->
    <div id="loading">&#1047;&#1072;&#1075;&#1088;&#1091;&#1079;&#1082;&#1072;...</div>

    <div class="toolbar">
        <button id="openBtn">üìÅ &#1054;&#1090;&#1082;&#1088;&#1099;&#1090;&#1100;</button>
        <button id="playBtn">‚ñ∂ &#1048;&#1075;&#1088;&#1072;&#1090;&#1100;</button>
        <button id="themeBtn">üåì &#1058;&#1077;&#1084;&#1072;</button>
        
        <select id="langSelector">
            <option value="ru">RU</option>
            <option value="en">EN</option>
        </select>

        <select id="trackList">
            <option data-lang="noFile">&#1053;&#1077;&#1090; &#1092;&#1072;&#1081;&#1083;&#1072;</option>
        </select>
    </div>

    <div id="tab-view">
        <div id="alphaTab"></div>
    </div>

    <input type="file" id="fileInput" accept=".gp,.gp3,.gp4,.gp5,.gpx" style="display:none">

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); 

        // –ü–µ—Ä–µ–≤–æ–¥—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Unicode Escapes (–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–Ω–∞–∫–æ–≤ –≤–æ–ø—Ä–æ—Å–∞)
        const translations = {
            ru: {
                open: "\uD83D\uDCC1 \u041E\u0442\u043A\u0440\u044B\u0442\u044C",
                play: "\u25B6 \u0418\u0433\u0440\u0430\u0442\u044C",
                pause: "\u23F8 \u041F\u0430\u0443\u0437\u0430",
                theme: "\u25D1 \u0422\u0435\u043C\u0430",
                loading: "\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...",
                noFile: "\u041D\u0435\u0442 \u0444\u0430\u0439\u043B\u0430"
            },
            en: {
                open: "\uD83D\uDCC1 Open",
                play: "\u25B6 Play",
                pause: "\u23F8 Pause",
                theme: "\u25D1 Theme",
                loading: "Loading...",
                noFile: "No file"
            }
        };

        let currentLang = 'ru';

        function updateInterface() {
            const t = translations[currentLang];
            document.getElementById('openBtn').innerText = t.open;
            document.getElementById('themeBtn').innerText = t.theme;
            document.getElementById('loading').innerText = t.loading;
            
            if (api && api.playerState === 1) {
                document.getElementById('playBtn').innerText = t.pause;
            } else {
                document.getElementById('playBtn').innerText = t.play;
            }

            const noFileOpt = document.querySelector('option[data-lang="noFile"]');
            if (noFileOpt) noFileOpt.innerText = t.noFile;
        }

        const el = document.querySelector('#alphaTab');
        const api = new alphaTab.AlphaTabApi(el, {
            player: {
                enablePlayer: true,
                soundFont: 'https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.3.0/dist/soundfonts/sonivox.sf2'
            }
        });

        document.getElementById('langSelector').onchange = (e) => {
            currentLang = e.target.value;
            updateInterface();
        };

        document.getElementById('openBtn').onclick = () => document.getElementById('fileInput').click();

        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('loading').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = (res) => {
                api.load(new Uint8Array(res.target.result));
            };
            reader.readAsArrayBuffer(file);
        };

        let isDark = false;
        document.getElementById('themeBtn').onclick = () => {
            isDark = !isDark;
            document.body.classList.toggle('dark-theme', isDark);
            api.settings.display.resources.mainColor = isDark ? '#ffffff' : '#000000';
            api.settings.display.staveRenderingConfig.staveColor = isDark ? '#ffffff' : '#000000';
            api.updateSettings();
            api.render();
        };

        api.scoreLoaded.on((score) => {
            document.getElementById('loading').style.display = 'none';
            const trackList = document.getElementById('trackList');
            trackList.innerHTML = '';
            score.tracks.forEach((track, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.innerText = track.name;
                trackList.appendChild(opt);
            });
            api.renderTracks([score.tracks[0]]);
        });

        document.getElementById('playBtn').onclick = () => api.playPause();

        api.playerStateChanged.on(() => {
            updateInterface();
        });

        window.addEventListener('resize', () => api.render());
        updateInterface();
    </script>
</body>
</html>


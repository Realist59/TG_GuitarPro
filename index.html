<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TG Guitar Player</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.7.1/dist/alphaTab.js"></script>
    <style>
        :root { --bg: #ffffff; --txt: #222222; --btn: #2481cc; --btn-txt: #ffffff; --bar: #f8f8f8; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; background: var(--bg); color: var(--txt); font-family: -apple-system, sans-serif; }
        body { display: flex; flex-direction: column; }
        .header { background: var(--bar); padding: 10px; padding-top: calc(10px + var(--tg-safe-area-inset-top, 0px)); display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); z-index: 10; }
        #trackList { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--btn); font-size: 14px; background: #fff; }
        #tab-view { flex: 1; overflow: auto; background: #ffffff; -webkit-overflow-scrolling: touch; }
        .controls { background: var(--bar); padding: 15px 10px; padding-bottom: calc(15px + var(--tg-safe-area-inset-bottom, 0px)); display: flex; justify-content: center; align-items: center; gap: 20px; border-top: 1px solid rgba(0,0,0,0.1); z-index: 10; }
        .btn-main { background: var(--btn); color: var(--btn-txt); border: none; border-radius: 12px; padding: 10px; min-width: 80px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: opacity 0.2s; }
        .btn-main:active { opacity: 0.7; }
        .btn-main span:last-child { font-size: 10px; text-transform: uppercase; }
        @media (orientation: landscape) { .controls { padding: 5px; gap: 30px; } .btn-main { min-width: 60px; padding: 5px; } .btn-main span:last-child { display: none; } .header { padding: 5px; padding-top: 5px; } }
        
        #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; padding: 20px; }
        .metronome-active { background: #e74c3c !important; }
        .at-cursor-bar { fill: rgba(36, 129, 204, 0.15); }
    </style>
</head>
<body>

    <div id="loading">
        <div style="font-size: 40px; margin-bottom: 20px;">üé∏</div>
        <div id="status">Initializing...</div>
        <button id="skipLoading" style="display:none; margin-top: 20px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; background: #eee;">Skip Loading</button>
    </div>

    <div class="header">
        <button onclick="document.getElementById('fileInput').click()" style="background:none; border:none; font-size:24px; cursor:pointer;">üìÅ</button>
        <select id="trackList"><option>No file loaded</option></select>
    </div>

    <div id="tab-view">
        <div id="alphaTab"></div>
    </div>

    <div class="controls">
        <button class="btn-main" id="playBtn">
            <span id="icoPlay" style="font-size: 24px;">‚ñ∂</span>
            <span id="txtPlay">Play</span>
        </button>
        <button class="btn-main" id="metroBtn">
            <span style="font-size: 24px;">‚è≤</span>
            <span>Metro</span>
        </button>
    </div>
    
    <input type="file" id="fileInput" accept=".gp,.gp3,.gp4,.gp5,.gpx" style="display:none">

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const el = document.querySelector('#alphaTab');
        const status = document.getElementById('status');
        const loader = document.getElementById('loading');
        const skipBtn = document.getElementById('skipLoading');
        let lastBar = -1;
        let metroOn = false;

        // Force hide loader after 12 seconds as a safety measure
        const safetyTimeout = setTimeout(() => {
            status.innerText = "Taking too long? Check if sonivox.sf2 is in your repo.";
            skipBtn.style.display = 'block';
        }, 12000);

        skipBtn.onclick = () => loader.style.display = 'none';

        const api = new alphaTab.AlphaTabApi(el, {
            importer: { encoding: 'cp1251' },
            player: { 
                enablePlayer: true, 
                enableMetronome: true, 
                enableCursor: true,
                soundFont: './sonivox.sf2' 
            },
            display: { layoutMode: 'page' }
        });

        function hideLoader() {
            clearTimeout(safetyTimeout);
            loader.style.display = 'none';
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'en-US';
                msg.rate = 1.2;
                window.speechSynthesis.speak(msg);
            }
        }

        api.soundFontLoad.on((e) => {
            const p = Math.floor(e.loaded / e.total * 100);
            status.innerText = `Loading Sounds: ${p}%`;
        });

        api.soundFontLoaded.on(() => {
            status.innerText = "Ready!";
            setTimeout(hideLoader, 600);
        });

        // Fallback if local file fails
        setTimeout(() => {
            if(loader.style.display !== 'none' && status.innerText === 'Initializing...') {
                status.innerText = "Local soundfont not found. Trying backup...";
                api.settings.player.soundFont = 'https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.7.1/dist/soundfont/sonivox.sf2';
                api.updateSettings();
            }
        }, 5000);

        document.getElementById('fileInput').onchange = (e) => {
            const f = e.target.files[0]; if(!f) return;
            loader.style.display = 'flex';
            status.innerText = "Loading File...";
            const r = new FileReader();
            r.onload = (res) => api.load(new Uint8Array(res.target.result));
            r.readAsArrayBuffer(f);
        };

        api.scoreLoaded.on((score) => {
            hideLoader();
            const tl = document.getElementById('trackList');
            tl.innerHTML = '';
            score.tracks.forEach((t, i) => {
                const o = document.createElement('option');
                o.value = i; o.innerText = t.name || `Track ${i+1}`;
                tl.appendChild(o);
            });
            api.renderTracks([score.tracks[0]]);
        });

        document.getElementById('trackList').onchange = (e) => {
            api.renderTracks([api.score.tracks[parseInt(e.target.value)]]);
        };

        api.playerPositionChanged.on((args) => {
            const currentBar = args.index + 1;
            if(currentBar !== lastBar) {
                lastBar = currentBar;
                speak(`Bar ${currentBar}`);
            }
        });

        document.getElementById('playBtn').onclick = () => api.playPause();

        document.getElementById('metroBtn').onclick = function() {
            metroOn = !metroOn;
            api.settings.player.metronomeVolume = metroOn ? 1 : 0;
            api.updateSettings();
            this.classList.toggle('metronome-active', metroOn);
        };

        api.playerStateChanged.on(() => {
            const isPlaying = api.playerState === 1;
            document.getElementById('icoPlay').innerText = isPlaying ? "‚è∏" : "‚ñ∂";
            document.getElementById('txtPlay').innerText = isPlaying ? "Pause" : "Play";
        });

        window.addEventListener('resize', () => api.render());
    </script>
</body>
</html>




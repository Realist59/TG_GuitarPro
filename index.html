<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GP Player</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.3.0/dist/alphaTab.js"></script>
    <style>
        :root { 
            --bg: #ffffff; --txt: #222222; --btn: #2481cc; --btn-txt: #ffffff; --bar: #ffffff;
        }
        
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100dvh; 
            overflow: hidden; background: var(--bg); color: var(--txt); 
            font-family: -apple-system, sans-serif; 
        }
        body { display: flex; flex-direction: column; }

        #tab-view { 
            flex: 1; overflow: auto; background: #ffffff; 
            -webkit-overflow-scrolling: touch; 
            padding-top: var(--tg-safe-area-inset-top, 0px);
        }

        .controls {
            background: var(--bar); padding: 15px 10px;
            padding-bottom: calc(15px + var(--tg-safe-area-inset-bottom, 0px));
            display: flex; justify-content: center; align-items: center; gap: 15px;
            border-top: 1px solid rgba(0,0,0,0.1); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 10;
        }

        .btn-main {
            background: var(--btn); color: var(--btn-txt); border: none; border-radius: 12px;
            padding: 10px 15px; font-size: 14px; font-weight: 600; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 5px; min-width: 80px;
        }

        @media (orientation: landscape) {
            .controls { padding: 5px 10px; padding-bottom: var(--tg-safe-area-inset-bottom, 5px); gap: 40px; }
            .btn-main { min-width: 50px; padding: 5px 10px; }
            .btn-main span:last-child { display: none; }
        }

        #loading { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(255,255,255,0.9); display: none; 
            flex-direction: column; align-items: center; justify-content: center; z-index: 1000; 
        }

        .metronome-active { background: #e74c3c !important; }
        
        /* Highlight for the current playback note */
        .at-cursor-bar { fill: rgba(36, 129, 204, 0.2); }
        .at-selection { fill: rgba(36, 129, 204, 0.1); }
    </style>
</head>
<body>
    <div id="loading">‚åõ <span id="txtLoad">Loading...</span></div>

    <div id="tab-view">
        <div id="alphaTab"></div>
    </div>

    <div class="controls">
        <button class="btn-main" id="openBtn">
            <span style="font-size: 20px;">üìÅ</span><span>Open</span>
        </button>
        <button class="btn-main" id="playBtn">
            <span id="icoPlay" style="font-size: 24px;">‚ñ∂</span><span id="txtPlay">Play</span>
        </button>
        <button class="btn-main" id="metroBtn">
            <span style="font-size: 20px;">‚è≤</span><span>Metro</span>
        </button>
    </div>
    
    <input type="file" id="fileInput" accept=".gp,.gp3,.gp4,.gp5,.gpx" style="display:none">

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const L = { play: "Play", pause: "Pause", load: "Loading...", bar: "Bar" };
        const el = document.querySelector('#alphaTab');
        let metronomeEnabled = false;
        let lastAnnouncedBar = -1;

        const api = new alphaTab.AlphaTabApi(el, {
            importer: { encoding: 'cp1251' },
            player: { 
                enablePlayer: true, 
                enableMetronome: true, 
                enableCursor: true, // –í–∫–ª—é—á–∞–µ—Ç –±–µ–≥—É—â—É—é –ø–æ–ª–æ—Å–∫—É
                soundFont: 'https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.3.0/dist/soundfonts/sonivox.sf2' 
            },
            display: {
                layoutMode: 'page', // –ú–æ–∂–Ω–æ —Å–º–µ–Ω–∏—Ç—å –Ω–∞ 'horizontal', –µ—Å–ª–∏ –Ω—É–∂–Ω—ã —Ç–∞–±—ã –≤ –æ–¥–Ω—É –ª–∏–Ω–∏—é
                autoSize: true
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–∑–≤—É—á–∫–∏
        function speakPosition(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.2;
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
            }
        }

        function updateUI() {
            const isPlaying = api.playerState === 1;
            document.getElementById('txtPlay').innerText = isPlaying ? L.pause : L.play;
            document.getElementById('icoPlay').innerText = isPlaying ? '‚è∏' : '‚ñ∂';
        }

        // –°–ª–µ–∂–µ–Ω–∏–µ –∑–∞ –ø–æ–∑–∏—Ü–∏–µ–π –ø–ª–µ–µ—Ä–∞
        api.playerPositionChanged.on((args) => {
            // –û–∑–≤—É—á–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ç–∞–∫—Ç–∞ (Bar) –ø—Ä–∏ –µ–≥–æ —Å–º–µ–Ω–µ
            const currentBar = args.index; 
            if (currentBar !== lastAnnouncedBar) {
                lastAnnouncedBar = currentBar;
                speakPosition(`${L.bar} ${currentBar + 1}`);
            }
        });

        document.getElementById('openBtn').onclick = () => document.getElementById('fileInput').click();
        
        document.getElementById('fileInput').onchange = (e) => {
            const f = e.target.files[0]; if (!f) return;
            document.getElementById('loading').style.display = 'flex';
            const r = new FileReader(); 
            r.onload = (res) => api.load(new Uint8Array(res.target.result));
            r.readAsArrayBuffer(f);
        };

        document.getElementById('playBtn').onclick = () => {
            if (api.playerState === 1) api.pause();
            else api.play();
        };

        document.getElementById('metroBtn').onclick = function() {
            metronomeEnabled = !metronomeEnabled;
            api.settings.player.metronomeVolume = metronomeEnabled ? 1 : 0;
            api.updateSettings();
            this.classList.toggle('metronome-active', metronomeEnabled);
        };

        api.scoreLoaded.on((s) => {
            document.getElementById('loading').style.display = 'none';
            lastAnnouncedBar = -1; // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
            api.renderTracks([s.tracks[0]]);
        });

        api.playerStateChanged.on(() => updateUI());
        window.addEventListener('resize', () => api.render());
    </script>
</body>
</html>

